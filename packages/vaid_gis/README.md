# `vaid_gis` 패키지

`vaid_gis`는 3D 지리 정보 데이터(GIS)를 카메라 영상에 맞게 2D로 투영(projection)하거나, 반대로 2D 영상 좌표를 3D 실제 공간 좌표로 역투영(unprojection)하는 핵심 기능을 수행하는 파이썬 패키지입니다.

## 설치

### 의존성

본 패키지는 다음 라이브러리에 의존합니다:
- `numpy`
- `geopandas`
- `shapely`
- `scipy`

이 의존성들은 `pip install` 시 자동으로 설치됩니다. `geopandas`는 시스템에 따라 추가적인 라이브러리(예: `GDAL`) 설치가 필요할 수 있습니다.

### 설치 방법

프로젝트의 다른 부분(예: `tools/video_analyzer`)에서 이 패키지를 사용하려면, 프로젝트 루트 디렉토리에서 "편집 가능 모드(-e)"로 설치하는 것을 권장합니다. 이렇게 하면 패키지 코드를 수정했을 때 변경사항이 즉시 다른 코드에 반영됩니다.

```bash
# 프로젝트 루트 디렉토리에서 실행
pip install -e packages/vaid_gis
```

## 기본 사용 예시

다음은 `MapProjector`를 사용하여 지도 데이터를 카메라 영상에 투영하는 기본적인 예시입니다.

```python
from vaid_gis.projector import MapProjector
from vaid_gis.camera import CameraParams

# 1. 카메라 파라미터 정의
params = CameraParams(
    x=328639.11, y=4161248.80, z=12.51,  # 카메라 위치 (UTM-52N 좌표계)
    yaw=177.0, pitch=-11.0, roll=0.0,       # 카메라 방향 (도 단위)
    fx=2601.0, fy=2601.0,                   # 초점 거리 (픽셀 단위)
    cx=960.0, cy=540.0,                     # 주점 (이미지 중심)
    resolution_width=1920, resolution_height=1080
)

# 2. MapProjector 초기화
# shp_root: 도로, 차선 등의 Shapefile이 들어있는 디렉토리 경로
projector = MapProjector(shp_root='./shp_files/your_map_data')

# 3. 카메라 위치 주변의 지도 데이터 로드 (반경 500m)
projector.load_map_data(x=params.x, y=params.y, radius=500)

# 4. 투영 실행
# 이 단계에서 3D 지도 데이터가 카메라 파라미터에 따라 2D 이미지 좌표로 변환됩니다.
projection_result = projector.projection(params)

# 5. 결과 사용
# 투영된 도로(B2) 레이어의 픽셀 좌표들을 가져옵니다.
# 결과는 OpenCV의 polylines 함수 등으로 이미지에 그릴 수 있는 numpy 배열 리스트입니다.
projected_road_lines = projection_result.projected_layers.get('b2', [])

print(f"투영된 도로 라인 {len(projected_road_lines)}개 발견!")
# 예: for line in projected_road_lines: cv2.polylines(image, [line], False, (0, 255, 0), 2)
```

---

## 상세 설명

### 1. `vaid_gis` 패키지란?

쉽게 말해, **현실 세계의 디지털 지도**와 **카메라 영상**을 서로 연결해주는 역할을 합니다. 이 패키지를 통해 우리는 카메라가 보고 있는 도로, 차선 등의 위치를 영상 위에 정확히 그리거나, 영상에서 클릭한 지점의 실제 현실 좌표(위도, 경도 등)를 알아낼 수 있습니다.

#### 주요 기능
- **지도 데이터 로딩**: Shapefile(.shp) 형식의 디지털 지도를 불러와 필요한 영역만 잘라냅니다.
- **3D 도로면 모델링**: 불러온 지도 데이터(특히 도로, 차선)의 높이(Z) 값을 이용해 현실과 유사한 3D 가상 도로 표면을 생성합니다.
- **투영 (Projection)**: 3D 지도 데이터를 특정 카메라의 시점에 맞춰 2D 영상 좌표로 변환합니다.
- **역투영 (Unprojection)**: 2D 영상 좌표를 3D 지도 위의 실제 지리 좌표로 변환합니다.
- **최근접 도로 탐색**: 특정 지점에서 가장 가까운 도로(차선) 정보를 빠르게 찾아냅니다.

---

## 2. 핵심 로직: 투영과 역투영

이 패키지의 가장 중요한 두 가지 개념은 '투영'과 '역투영'입니다.

### 2.1. 투영 (Projection): 현실 공간을 카메라 영상으로 옮기기

> **비유**: 우리가 특정 장소에서 카메라로 **사진을 찍는 과정**과 같습니다. 3차원 현실 풍경(지도)이 2차원 사진(카메라 영상)으로 담기는 것과 동일합니다.

`vaid_gis`는 다음 단계를 거쳐 3D 지도 데이터를 2D 영상으로 투영합니다.

1.  **3D 지도 준비**: Shapefile에서 도로, 차선 등의 3D 좌표(X, Y, Z)를 읽어옵니다. 이 좌표들은 실제 세계 기준(예: ENU 좌표계 - 동쪽, 북쪽, 위쪽)으로 설정되어 있습니다.

2.  **카메라 준비**: 사진을 찍을 카메라의 정보를 설정합니다.
    *   **카메라 위치와 방향 (Extrinsic Params)**: 카메라가 어디에(X, Y, Z) 설치되어 있으며, 어느 방향(Yaw, Pitch, Roll)을 바라보는지 정의합니다.
    *   **카메라 렌즈 특성 (Intrinsic Params)**: 렌즈의 초점 거리(fx, fy), 이미지 중심점(cx, cy) 등 카메라 고유의 광학적 특성을 정의합니다. 렌즈 왜곡(k1, k2...) 정보도 여기에 포함됩니다.

3.  **카메라 시점으로 변환**: 모든 3D 지도 좌표들을 **카메라의 시점**에서 본 상대적인 좌표로 변환합니다. 즉, 카메라를 3D 공간의 원점(0,0,0)으로 만들고, 카메라가 정면을 바라보도록 모든 지도 데이터를 회전 및 이동시킵니다.

4.  **원근 투영 (Perspective Projection)**: "가까운 것은 크게 보이고, 먼 것은 작게 보이는" 원근법을 적용합니다. 3단계에서 변환된 3D 좌표들을 2D 평면(가상의 필름)에 맺히게 합니다. 이 과정에서 `z` (깊이) 값이 사용됩니다.

5.  **왜곡 보정 (Distortion)**: 실제 카메라 렌즈는 가장자리가 왜곡되는 현상(어안 렌즈 효과 등)이 있습니다. 2단계에서 설정한 왜곡 계수(k1, k2 등)를 이용해 이 왜곡을 수학적으로 적용하여 실제 영상과 똑같이 보이도록 좌표를 조절합니다.

6.  **최종 픽셀 좌표로 변환**: 계산된 2D 좌표에 렌즈의 초점 거리, 이미지 중심점을 곱하고 더해 최종적으로 우리가 보는 이미지의 픽셀 좌표(u, v)로 변환합니다.

이 과정을 거치면, 3D 지도 상의 모든 선과 점들이 카메라 영상의 특정 픽셀 위치에 정확하게 그려질 수 있습니다.

### 2.2. 역투영 (Unprojection): 영상 속 지점의 실제 위치 찾기

> **비유**: 사진 속의 특정 지점을 **손가락으로 가리키고**, 그 방향으로 **레이저 포인터를 쏘았을 때**, 레이저가 현실 세계의 어떤 물체에 닿는지 확인하는 과정과 같습니다.

역투영은 투영의 역순으로 진행되며, 훨씬 더 복잡한 추론이 필요합니다.

1.  **"광선(Ray)" 생성**: 사용자가 영상에서 클릭한 픽셀 좌표(u, v)와 카메라의 렌즈 정보, 위치 정보를 이용해, **카메라 렌즈의 중심**에서부터 그 **픽셀을 통과하여 현실 세계로 뻗어나가는 가상의 직선(Ray)**을 수학적으로 계산합니다.

2.  **3D 도로면 모델과 교차점 탐색**: 이제 이 광선이 어떤 물체와 부딪히는지 찾아야 합니다. `vaid_gis`는 투영 과정에서 미리 생성해 둔 **3D 삼각망(Mesh) 도로면 모델**과 광선이 만나는 지점을 찾습니다. (Möller–Trumbore 알고리즘 사용)

3.  **정확한 3D 좌표 반환**: 광선과 3D 도로면이 부딪히는 지점의 3D 좌표(X, Y, Z)가 바로 사용자가 영상에서 클릭한 지점의 **실제 현실 세계 좌표**입니다.

#### ※ 만약 도로면과 교차점이 없다면? (추론 과정)

광선이 도로면을 벗어나는 경우(예: 하늘, 건물 등), 교차점을 직접 찾을 수 없습니다. 이 경우, `vaid_gis`는 다음과 같은 방법으로 위치를 **추론**합니다.

1.  사용자가 클릭한 지점(A)에서 **가장 가까운 2D 투영 결과물(도로선 등)**을 찾습니다.
2.  이 도로선의 2D-3D 좌표 정보를 모두 알고 있으므로, 클릭 지점(A)에서 도로선에 수직으로 내린 점(B)의 3D 좌표를 계산할 수 있습니다.
3.  이 3D 좌표(B)에서 수평면(갓길 등)을 가정하고, 맨 처음 계산했던 **광선**과 이 **가상 수평면**의 교차점을 계산하여 최종 위치를 예측합니다.

---

## 3. 주요 모듈 설명

`vaid_gis` 패키지는 다음과 같은 모듈들로 구성되어 있습니다.

-   `projector.py`
    -   `MapProjector` 클래스가 포함된 **가장 핵심적인 파일**입니다.
    -   지도 로딩, 투영, 역투영, 최근접 도로 탐색 등 패키지의 모든 주요 기능을 총괄하고 실행합니다.

-   `camera.py`
    -   카메라의 모든 파라미터(위치, 방향, 렌즈 특성 등)를 정의하는 `CameraParams` 데이터 클래스를 제공합니다.

-   `geometry.py`
    -   좌표계 변환, 회전 행렬 계산, 왜곡/왜곡 보정 함수, 광선-메시 교차점 계산 등 모든 핵심적인 기하학 연산을 담당하는 함수들을 모아놓은 파일입니다.

-   `surface.py`
    -   불러온 지도 데이터를 바탕으로 3D 도로면 보간 모델과 삼각망(Delaunay Triangulation)을 생성하는 역할을 합니다. 역투영 시 교차점 계산에 사용됩니다.

-   `loader.py`
    -   Shapefile(.shp)을 읽고, 특정 영역을 기준으로 데이터를 필터링하여 메모리에 로드하는 역할을 합니다.

-   `setup.py`
    -   `vaid_gis` 패키지를 설치하고 의존성(numpy, geopandas 등)을 관리하기 위한 설정 파일입니다.

# 카메라 파라미터 최적화 알고리즘

## 개요

차선 라벨링 데이터에 맞춰 카메라 파라미터(yaw, pitch, roll, fx, fy)를 자동으로 피팅하기 위해 사용하는 최적화 알고리즘들을 정리한 문서입니다.

---

## 현재 구현된 알고리즘 (3가지)

### 1. Powell

**방식**: 방향 탐색 (Direction Set Method)

**원리**:
- 각 파라미터 축 방향으로 순차적으로 1차원 최적화를 수행
- 한 방향으로 최적점을 찾은 후 다음 방향으로 이동
- 모든 방향을 탐색한 후, 새로운 방향 벡터를 생성하여 반복

**장점**:
- 그래디언트(기울기) 계산이 필요 없음
- 경계(bounds) 조건 지원
- 구현이 간단하고 범용적

**단점**:
- 국소 최적점(local minimum)에 빠지기 쉬움
- 파라미터 간 상관관계가 강할 때 수렴이 느림
- 고차원에서 효율이 떨어질 수 있음

**적합한 상황**:
- 파라미터 수가 적고 경계 조건이 필요할 때
- 비용 함수의 그래디언트를 계산하기 어려울 때

---

### 2. Nelder-Mead (Simplex Method)

**방식**: 심플렉스 기반 직접 탐색

**원리**:
- N차원 공간에서 (N+1)개의 꼭짓점을 가진 심플렉스(다면체)를 사용
- 심플렉스를 반사(reflection), 확장(expansion), 수축(contraction), 축소(shrink) 연산으로 변형
- 비용이 가장 높은 꼭짓점을 계속 대체하며 최적점으로 수렴

**장점**:
- 그래디언트 계산이 필요 없음
- 노이즈가 있는 비용 함수에 강건함
- 수렴이 안정적
- 저차원(10개 이하 파라미터)에서 효과적

**단점**:
- 경계 조건을 직접 지원하지 않음 (후처리로 클리핑 필요)
- 고차원에서 수렴 속도가 급격히 느려짐
- 이론적 수렴 보장이 약함

**적합한 상황**:
- 비용 함수에 노이즈가 있을 때
- 파라미터 수가 10개 이하일 때
- 그래디언트 기반 방법이 실패할 때

---

### 3. Levenberg-Marquardt (LM)

**방식**: 비선형 최소제곱 (Nonlinear Least Squares)

**원리**:
- Gauss-Newton 방법과 경사하강법의 혼합
- 야코비안(Jacobian) 행렬을 사용하여 2차 근사
- 댐핑 파라미터(λ)로 두 방법 사이를 적응적으로 전환
  - λ가 크면 → 경사하강법처럼 동작 (안정적)
  - λ가 작으면 → Gauss-Newton처럼 동작 (빠름)

**장점**:
- 비선형 최소제곱 문제에 특화
- 수렴 속도가 빠름
- 로봇 비전, 카메라 캘리브레이션의 사실상 표준
- 각 데이터 포인트의 잔차(residual)를 활용하여 효율적

**단점**:
- 비용 함수가 "잔차 제곱합" 형태여야 함
- 야코비안 계산 필요 (수치 미분 사용 시 비용 증가)
- 초기값에 민감할 수 있음

**적합한 상황**:
- 카메라 캘리브레이션, 포즈 추정
- 데이터 포인트별 오차를 개별적으로 계산할 수 있을 때
- 정확도가 중요한 경우

---

## 3가지 알고리즘 비교

| 항목 | Powell | Nelder-Mead | LM |
|------|--------|-------------|-----|
| **방식** | 방향 탐색 | 심플렉스 | 비선형 최소제곱 |
| **그래디언트** | 불필요 | 불필요 | 필요 (수치 미분 가능) |
| **경계 지원** | O | X (후처리) | O |
| **노이즈 강건성** | 보통 | 강함 | 보통 |
| **수렴 속도** | 보통 | 느림 | 빠름 |
| **정확도** | 보통 | 보통 | 높음 |
| **권장 파라미터 수** | 제한 없음 | 10개 이하 | 제한 없음 |
| **로봇 비전 사용** | 드묾 | 가끔 | 표준 |

---

## 추가 알고리즘 (scipy.optimize에서 제공)

### 그래디언트 기반

| 알고리즘 | 설명 | 경계 | 특징 |
|----------|------|------|------|
| **CG** | 켤레 기울기법 (Conjugate Gradient) | X | 대규모 문제에 효율적, 메모리 절약 |
| **BFGS** | 준뉴턴법 (Quasi-Newton) | X | 헤시안 근사, 수렴 빠름 |
| **L-BFGS-B** | 메모리 효율적 BFGS | O | 대규모 문제, 경계 지원 |
| **TNC** | 뉴턴 켤레 기울기 (Truncated Newton) | O | 대규모 경계 문제에 적합 |
| **SLSQP** | 순차 이차 계획법 | O | 등식/부등식 제약조건 지원 |
| **trust-constr** | 신뢰 영역 기반 | O | 복잡한 제약조건 지원 |

### 그래디언트 불필요

| 알고리즘 | 설명 | 경계 | 특징 |
|----------|------|------|------|
| **COBYLA** | 선형 근사 기반 | O | 제약조건 지원, 노이즈에 강함 |

---

## 로봇 비전 분야에서 사용하는 전문 라이브러리

실제 프로덕션 환경에서는 scipy보다 전문 라이브러리를 더 많이 사용합니다.

### Ceres Solver (Google)

- **용도**: Bundle Adjustment, SLAM, 카메라 캘리브레이션
- **특징**: C++ 기반, 자동 미분, 희소 행렬 최적화
- **알고리즘**: LM, Dogleg, Trust Region
- **사용처**: Google Street View, Cartographer SLAM

### g2o (General Graph Optimization)

- **용도**: 그래프 기반 SLAM
- **특징**: 희소 행렬 특화, 포즈 그래프 최적화
- **알고리즘**: Gauss-Newton, LM
- **사용처**: ORB-SLAM, LSD-SLAM

### GTSAM (Georgia Tech Smoothing and Mapping)

- **용도**: Factor Graph 기반 추론
- **특징**: 확률적 추론, 증분 최적화 (iSAM2)
- **알고리즘**: Gauss-Newton, LM, iSAM2
- **사용처**: 자율주행, 드론 내비게이션

### OpenCV (solvePnP)

- **용도**: 카메라 포즈 추정
- **특징**: 간단한 API, 다양한 방법 지원
- **알고리즘**: EPnP, P3P, IPPE, LM refinement
- **사용처**: AR, 로봇 비전

---

## 알고리즘 선택 가이드

```
비용 함수가 "잔차 제곱합" 형태인가?
├── 예 → Levenberg-Marquardt (LM) 권장
│        (가장 빠르고 정확)
│
└── 아니오 → 그래디언트 계산이 가능한가?
              ├── 예 → L-BFGS-B 권장
              │        (빠른 수렴, 경계 지원)
              │
              └── 아니오 → 노이즈가 많은가?
                          ├── 예 → Nelder-Mead 권장
                          │        (노이즈에 강건)
                          │
                          └── 아니오 → Powell 권장
                                       (범용적, 경계 지원)
```

---

## 현재 프로젝트에서의 적용

### 비용 함수 정의

```
비용 = 평균(각 라벨링 점에서 가장 가까운 투영 점까지의 거리)
```

### 최적화 대상 파라미터 (5개)

| 파라미터 | 설명 | 탐색 범위 |
|----------|------|-----------|
| yaw | 수평 회전 | ±10도 |
| pitch | 수직 회전 | ±10도 |
| roll | 축 회전 | ±10도 |
| fx | 수평 초점거리 | ±20% |
| fy | 수직 초점거리 | ±20% |

### 권장 사용 순서

1. **LM**: 가장 먼저 시도 (로봇 비전 표준)
2. **Nelder-Mead**: LM이 실패하거나 노이즈가 의심될 때
3. **Powell**: 빠른 대략적 추정이 필요할 때

---

## 참고 자료

- [scipy.optimize.minimize 문서](https://docs.scipy.org/doc/scipy/reference/generated/scipy.optimize.minimize.html)
- [scipy.optimize.least_squares 문서](https://docs.scipy.org/doc/scipy/reference/generated/scipy.optimize.least_squares.html)
- [Ceres Solver](http://ceres-solver.org/)
- [g2o](https://github.com/RainerKuemmerle/g2o)
- [GTSAM](https://gtsam.org/)

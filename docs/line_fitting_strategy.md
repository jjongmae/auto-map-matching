# 차선 피팅 전략: 점 단위 vs 그룹 단위 매칭

이 문서는 자동 차선 피팅(Auto Fitting) 기능의 고도화를 위해 논의된 **매칭 전략**에 대해 기술합니다. 기존의 점(Point) 단위 매칭 방식의 한계를 분석하고, 이를 개선하기 위한 그룹(Line/Group) 단위 매칭 아이디어를 정리합니다.

## 1. 개요
카메라 매개변수(Extrinsic/Intrinsic)를 최적화하기 위해서는 사용자가 이미지 위에 그린 **"라벨링 차선(Ground Truth)"**과 지도 데이터 상의 **"실제 차선(Map Data)"** 간의 오차(Error)를 최소화해야 합니다. 이때 이 오차를 어떻게 정의하고 계산하느냐가 피팅 성능을 좌우합니다.

## 2. 기존 방식: 점 단위 매칭 (Point-to-Map)
초기 구현 방식은 라벨링된 모든 차선의 점들을 하나의 거대한 **점 구름(Point Cloud)**으로 취급하는 방식입니다.

### 동작 원리
1. 사용자가 그린 모든 차선의 점 `P_all`을 하나의 리스트로 합칩니다.
2. 현재 카메라 파라미터로 지도의 차선들을 이미지 평면에 투영합니다.
3. 각 점 `P_i`에 대해, 투영된 지도 상의 **모든 점들 중 가장 가까운 점**을 찾아 그 거리를 오차로 정의합니다.
4. 모든 점들의 오차 평균을 최소화하는 방향으로 최적화를 수행합니다.

### 한계점 (Problem)
*   **비일관성 (Incoherence):** 같은 차선에 속한 점들이라도, 노이즈나 초기 위치 오차로 인해 서로 다른 지도 차선에 매칭될 수 있습니다.
    *   *예: 1차선 라벨링 점들의 앞부분은 지도의 1차선에, 뒷부분은 지도의 2차선에 붙어버리는 현상.*
*   **지역 최적해(Local Minima) 위험:** 점들이 가장 가까운 곳으로만 가려고 하므로, 전체적인 차선의 형상(Shape)을 고려하지 못하고 엉뚱한 차선에 고착될 가능성이 높습니다.

## 3. 제안 방식: 그룹 단위 매칭 (Group-to-Group / Line-to-Map)
사용자가 그린 **"하나의 선(Stroke)"**은 물리적으로 **"하나의 지도 차선"**에 대응된다는 강력한 제약 조건을 활용하는 방식입니다.

### 핵심 아이디어
*   라벨링 데이터도 `그룹(Line)`, 지도 데이터도 `그룹(Line)`으로 관리합니다.
*   점 하나하나가 독립적으로 매칭 대상을 찾는 것이 아니라, **그룹 전체가 하나의 지도 차선을 선택**하여 매칭합니다.

### 장점 (Benefits)
1.  **강건함 (Robustness):** 개별 점이 노이즈로 인해 튀더라도, 그룹 내의 다른 점들이 올바른 차선(Overall Trend)을 유지해주므로 전체적인 매칭이 안정적입니다.
2.  **형상 유지:** 차선의 곡률이나 방향성이 지도 데이터와 일치하도록 유도하는 효과가 있습니다.
3.  **오매칭 감소:** 1차선 라벨링 전체가 2차선 라벨링 전체와 경쟁하여, 가장 에러가 적은 쪽으로 '통째로' 매칭되므로 논리적인 오류(한 선이 두 갈래로 찢어지는 현상 등)를 방지합니다.

## 4. 구현 알고리즘 (Soft Association)
사용자가 일일이 "이 선은 지도 ID 101번"이라고 지정하는 것은 번거로우므로, 최적화 과정에서 자동으로 짝을 찾는 방식을 사용합니다.

### 비용 함수 (Cost Function) 로직
최적화 루프 내에서 비용을 계산할 때마다 다음 절차를 수행합니다:

1.  **입력:** 사용자 라벨링 그룹 리스트 `[L_user_1, L_user_2, ...]`
2.  **투영:** 현재 파라미터로 지도를 투영하여 지도 라인 리스트 `[L_map_1, L_map_2, ...]` 생성
3.  **최적 매칭 탐색:**
    *   각 `L_user_i`에 대해:
        *   모든 `L_map_j`와의 평균 거리를 계산합니다.
        *   가장 거리가 짧은(에러가 적은) 지도 라인 `L_map_best`를 선택합니다.
        *   `Cost_i = Distance(L_user_i, L_map_best)`
4.  **최종 비용:** 모든 그룹의 `Cost_i` 합(또는 평균)을 반환합니다.

## 5. 결론
이러한 그룹 기반 접근 방식은 특히 초기 오차가 크거나, 차선이 조밀하게 모여 있는 복잡한 도로 환경에서 **Levenberg-Marquardt**나 **Powell** 알고리즘이 올바른 해(Global Optimum)를 찾는 데 큰 도움을 줄 것으로 기대됩니다.
